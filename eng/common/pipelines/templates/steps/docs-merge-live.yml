# intended to be used as part of a release process
parameters:
  ArtifactLocation: 'not-specified'
  PackageRepository: 'not-specified'
  ReleaseSha: 'not-specified'
  RepoId: $(Build.Repository.Name)
  WorkingDirectory: ''
  ScriptDirectory: eng/common/scripts
  TargetDocRepoName: ''
  TargetDocRepoOwner: ''
  PRBranchName: 'live'
  SourceBranchName: 'master'
  PRLabels: 'auto-merge'
  OnboardingBranch: ''
  SkipPackageJson: false

steps:
- pwsh: |
    git clone https://github.com/${{ parameters.TargetDocRepoOwner }}/${{ parameters.TargetDocRepoName }} ${{ parameters.WorkingDirectory }}/repo

    try {
      Push-Location ${{ parameters.WorkingDirectory }}

      Write-Host "git checkout ${{ parameters.SourceBranchName }}"
      git checkout ${{ parameters.SourceBranchName }}
    } finally {
      Pop-Location
    }
  displayName: Clone Documentation Repository
  ignoreLASTEXITCODE: false
- pwsh: |
    $ciLastCommit = git log --author="VSC-Service-Account" --pretty=format:'%H' -n 1
    echo "##vso[task.setvariable variable=CICommit]$ciLastCommit"
  workingDirectory: ${{ parameters.WorkingDirectory }}
  displayName: Fetch the last commit for Job CI commits.
  
- pwsh: |
    git reset --hard $(CICommit)
    git checkout -b for-release
  displayName: 'Checkout new branch for-release'
  workingDirectory: ${{ parameters.WorkingDirectory }}
  ignoreLASTEXITCODE: false

- template: /eng/common/pipelines/templates/steps/create-pull-request.yml
  parameters:
    RepoName: ${{ parameters.TargetDocRepoName }}
    RepoOwner: ${{ parameters.TargetDocRepoOwner }}
    PRBranchName: "live"
    BaseBranchName: "for-release"
    CommitMsg: "Daily merge from most recent CI job commit to live."
    PRTitle: "Merge from recent CI job to live"
    WorkingDirectory: ${{ parameters.WorkingDirectory }}
    GHReviewersVariable: ${{ parameters.GHReviewersVariable }}
    GHTeamReviewersVariable: ${{ parameters.GHTeamReviewersVariable }}
    CloseAfterOpenForTesting: $false
